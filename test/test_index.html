<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whalgebra 测试控制台 v3.2</title>
    <style>
        :root {
            /* === 核心色板 (与主页保持一致) === */
            --hue: 220;
            --primary: hsl(var(--hue), 90%, 60%);
            --text-main: #1E293B;
            --text-sub: #64748B;

            /* === 玻璃拟态参数 === */
            --glass-surface: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.8);
            --glass-shadow: 0 20px 40px -5px rgba(22, 28, 45, 0.1),
            inset 0 1px 0 0 rgba(255, 255, 255, 0.8);

            /* === 控制台深色玻璃 === */
            --console-bg: rgba(30, 41, 59, 0.85);
            --console-header: rgba(15, 23, 42, 0.6);
            --console-text: #E2E8F0;
            --console-hover: rgba(255, 255, 255, 0.05);
            --console-error-bg: rgba(239, 68, 68, 0.15);

            /* === 语义色 === */
            --status-success: #34D399;
            --status-error: #F87171;
            --status-warn: #FBBF24;
            --status-info: #60A5FA;
            --status-sys: #A78BFA;

            /* === JSON 高亮 === */
            --json-key: #7DD3FC;
            --json-string: #FDA4AF;
            --json-number: #BEF264;
            --json-boolean: #60A5FA;
            --json-null: #C4B5FD;
            --json-punct: #94A3B8;

            /* === 背景光斑 === */
            --blob-1: #667EEA;
            --blob-2: #764BA2;
            --blob-3: #FF9A9E;

            --font-ui: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
            --font-code: "JetBrains Mono", "Consolas", "Monaco", monospace;
        }

        * {
            box-sizing: border-box;
            outline: none;
        }

        body {
            font-family: var(--font-ui);
            background: #F8FAFC;
            margin: 0;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            gap: 16px;
            overflow: hidden;
            color: var(--text-main);
            position: relative;
        }

        /* === 动态背景层 === */
        .liquid-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(circle at center, #FDFBFB 0%, #EBEDEE 100%);
            overflow: hidden;
            pointer-events: none;
        }

        .blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.6;
            will-change: transform;
        }

        .blob-1 {
            width: 600px;
            height: 600px;
            background: var(--blob-1);
            top: -200px;
            left: -200px;
            animation: float 25s infinite alternate ease-in-out;
        }

        .blob-2 {
            width: 500px;
            height: 500px;
            background: var(--blob-2);
            bottom: -150px;
            right: -150px;
            animation: float 30s infinite alternate-reverse ease-in-out;
        }

        .blob-3 {
            width: 400px;
            height: 400px;
            background: var(--blob-3);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: float-center 22s infinite ease-in-out;
        }

        @keyframes float {
            0% {
                transform: translate(0, 0) scale(1);
            }
            100% {
                transform: translate(30px, 50px) scale(1.1);
            }
        }

        @keyframes float-center {
            0% {
                transform: translate(-50%, -50%) rotate(0deg);
            }
            50% {
                transform: translate(-40%, -60%) rotate(45deg);
            }
            100% {
                transform: translate(-50%, -50%) rotate(0deg);
            }
        }

        /* === 通用玻璃卡片样式 === */
        .glass-panel {
            background: var(--glass-surface);
            backdrop-filter: blur(24px) saturate(180%);
            -webkit-backdrop-filter: blur(24px) saturate(180%);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            border-radius: 20px;
        }

        /* --- Header --- */
        .header-bar {
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            animation: fadeIn Down 0.5s ease-out;
            user-select: none;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 800;
            background: linear-gradient(135deg, #1E3A8A 0%, #3B82F6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.02em;
        }

        /* 状态胶囊 */
        .status-badge {
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-sub);
            background: rgba(255, 255, 255, 0.5);
            padding: 6px 16px;
            border-radius: 50px;
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
            font-weight: 600;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #CBD5E1;
            position: relative;
            transition: all 0.3s;
        }

        /* 呼吸灯效果 */
        .status-dot::after {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 50%;
            background: currentColor;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .status-dot.active {
            background: #10B981;
            color: #10B981;
            box-shadow: 0 0 10px #10B981;
        }

        .status-dot.active::after {
            opacity: 0.3;
            animation: pulse 2s infinite;
        }

        .status-dot.error {
            background: var(--status-error);
            color: var(--status-error);
            box-shadow: 0 0 10px var(--status-error);
        }

        .status-dot.loading {
            background: var(--status-warn);
            color: var(--status-warn);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 0.3;
            }
            50% {
                transform: scale(1.5);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 0;
            }
        }

        /* --- Layout --- */
        .main-layout {
            display: flex;
            gap: 16px;
            flex: 1;
            overflow: hidden;
            min-height: 0;
        }

        /* --- Sidebar --- */
        .control-panel {
            width: 260px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            flex-shrink: 0;
            user-select: none;
        }

        .section-title {
            font-size: 12px;
            color: var(--text-sub);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            padding-left: 4px;
        }

        /* --- Buttons --- */
        button {
            display: block;
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 10px;
            border-radius: 12px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            font-size: 14px;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.4);
            color: var(--text-main);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
            position: relative;
            overflow: hidden;
        }

        button:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.8);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border-color: #FFF;
        }

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            filter: grayscale(1);
            transform: none !important;
            background: rgba(200, 200, 200, 0.1);
        }

        /* 主要按钮样式 */
        button.primary {
            background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(118, 75, 162, 0.3);
            text-align: center;
        }

        button.primary:hover:not(:disabled) {
            box-shadow: 0 8px 20px rgba(118, 75, 162, 0.4);
            background: linear-gradient(135deg, #764BA2 0%, #667EEA 100%);
        }

        /* --- Console --- */
        .console-panel {
            flex: 1;
            background: var(--console-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(20px);
        }

        .console-header {
            background: var(--console-header);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            flex-shrink: 0;
            user-select: none;
        }

        .console-title {
            color: #94A3B8;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 1px;
            font-family: var(--font-code);
        }

        .btn-small {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #CBD5E1;
            padding: 4px 10px;
            font-size: 11px;
            border-radius: 6px;
            cursor: pointer;
            width: auto;
            margin: 0;
            display: inline-block;
            box-shadow: none;
        }

        .btn-small:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #FFF;
            transform: none;
        }

        #output {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            font-family: var(--font-code);
            font-size: 13px;
            line-height: 1.6;
            color: var(--console-text);
        }

        /* 滚动条美化 */
        #output::-webkit-scrollbar {
            width: 8px;
        }

        #output::-webkit-scrollbar-track {
            background: transparent;
        }

        #output::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        #output::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .control-panel::-webkit-scrollbar {
            width: 4px;
        }

        .control-panel::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }

        /* --- Log Rows --- */
        .log-row {
            display: flex;
            padding: 6px 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            align-items: flex-start;
            border-left: 3px solid transparent;
            transition: background 0.1s;
            border-radius: 4px;
        }

        .log-row:hover {
            background: var(--console-hover);
        }

        .log-row-error {
            background: var(--console-error-bg);
            border-left: 3px solid var(--status-error);
        }

        .log-meta {
            flex-shrink: 0;
            width: 140px;
            display: flex;
            font-size: 12px;
            color: #64748B;
            user-select: none;
            padding-top: 2px;
        }

        .log-time {
            margin-right: 10px;
            opacity: 0.7;
            font-feature-settings: "tnum";
        }

        .log-tag {
            font-weight: bold;
            font-size: 11px;
            padding: 1px 4px;
            border-radius: 3px;
            background: rgba(0, 0, 0, 0.2);
        }

        .tag-info {
            color: var(--status-info);
        }

        .tag-success {
            color: var(--status-success);
        }

        .tag-warn {
            color: var(--status-warn);
        }

        .tag-error {
            color: var(--status-error);
        }

        .tag-sys {
            color: var(--status-sys);
        }

        .log-content {
            flex: 1;
            word-break: break-all;
            min-width: 0;
        }

        /* --- JSON Tree (适配深色模式) --- */
        .json-tree {
            font-family: var(--font-code);
            cursor: default;
        }

        .jv-string {
            color: var(--json-string);
        }

        .jv-number {
            color: var(--json-number);
        }

        .jv-boolean {
            color: var(--json-boolean);
        }

        .jv-null {
            color: var(--json-null);
        }

        .jv-key {
            color: var(--json-key);
        }

        .jv-punct {
            color: var(--json-punct);
        }

        .jv-toggle {
            display: inline-block;
            width: 14px;
            text-align: center;
            cursor: pointer;
            color: #64748B;
            font-size: 10px;
            transition: transform 0.1s ease;
            user-select: none;
            vertical-align: middle;
        }

        .jv-toggle:hover {
            color: #FFF;
        }

        .jv-node.collapsed > .jv-children {
            display: none !important;
        }

        .jv-node.collapsed > div > .jv-toggle {
            transform: rotate(-90deg);
        }

        .jv-node.collapsed > div > .jv-ellipsis {
            display: inline !important;
        }

        .jv-node.collapsed > .jv-footer {
            display: inline !important;
            margin-left: 0;
        }

        .jv-node.expanded > .jv-children {
            display: block !important;
        }

        .jv-node.expanded > div > .jv-toggle {
            transform: rotate(0deg);
        }

        .jv-node.expanded > div > .jv-ellipsis {
            display: none !important;
        }

        .jv-node.expanded > .jv-footer {
            display: block !important;
            margin-left: 14px;
        }

        .jv-ellipsis {
            color: #64748B;
            font-size: 12px;
            margin: 0 4px;
            cursor: pointer;
        }

        .jv-children {
            margin-left: 14px;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            padding-left: 5px;
        }

        .jv-item {
            display: block;
        }

        .jv-footer {
            color: var(--json-punct);
        }

        iframe {
            display: none;
        }
    </style>
</head>
<body>

<div class="liquid-bg">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div class="blob blob-3"></div>
</div>

<div class="header-bar glass-panel">
    <h2>Whalgebra 测试控制台 <small
            style="font-size: 13px; color: var(--text-sub); margin-left:12px; font-weight:normal; opacity: 0.8;">v3.1</small>
    </h2>
    <div class="status-badge">
        <span id="statusDot" class="status-dot loading"></span>
        <span id="statusText">正在等待连接...</span>
    </div>
</div>

<div class="main-layout">
    <div class="control-panel glass-panel">
        <div>
            <div class="section-title">全局操作</div>
            <button id="testBtn" class="primary" onclick="uiRunTest(0)" disabled>运行全部测试集</button>
            <button id="clearBtn" onclick="clearLog()">清空控制台</button>
        </div>
        <div>
            <div class="section-title">单元测试用例</div>
            <button class="test-case-btn" onclick="uiRunTest(1)" disabled>1. 性能测试</button>
            <button class="test-case-btn" onclick="uiRunTest(2)" disabled>2. 幂函数分析</button>
            <button class="test-case-btn" onclick="uiRunTest(3)" disabled>3. 统计计算</button>
            <button class="test-case-btn" onclick="uiRunTest(4)" disabled>4. 根式函数</button>
            <button class="test-case-btn" onclick="uiRunTest(5)" disabled>5. 函数值列表</button>
            <button class="test-case-btn" onclick="uiRunTest(6)" disabled>6. 表达式解析</button>
        </div>
    </div>

    <div class="console-panel">
        <div class="console-header">
            <span class="console-title">DEBUG CONSOLE</span>
            <button class="btn-small" onclick="toggleAutoScroll()" id="btnAutoScroll"
                    style="color:#CBD5E1; border-color:rgba(255,255,255,0.2);">自动滚动: ON
            </button>
        </div>
        <div id="output"></div>
    </div>
</div>

<iframe id="logicEngine" src="../src/Whalgebra.html"></iframe>

<script>
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const output = document.getElementById('output');
    const iframe = document.getElementById('logicEngine');
    let isAutoScroll = true;

    // --- JSON 构建 ---
    function createSpan(text, className) {
        const span = document.createElement('span');
        span.className = className;
        span.textContent = text;
        return span;
    }

    function createJsonTree(data, key = null) {
        if (data === null) {
            return renderPrimitive('null', 'jv-null', key);
        }
        if (data === undefined) {
            return renderPrimitive('undefined', 'jv-null', key);
        }
        if (typeof data === 'boolean') {
            return renderPrimitive(data.toString(), 'jv-boolean', key);
        }
        if (typeof data === 'number') {
            return renderPrimitive(data.toString(), 'jv-number', key);
        }
        if (typeof data === 'string') {
            return renderPrimitive(`"${data}"`, 'jv-string', key);
        }
        if (typeof data !== 'object') {
            return renderPrimitive(String(data), 'jv-string', key);
        }

        const isArray = Array.isArray(data);
        const isEmpty = Object.keys(data).length === 0;
        const openChar = isArray ? '[' : '{';
        const closeChar = isArray ? ']' : '}';

        const container = document.createElement('div');
        container.className = 'jv-node collapsed json-tree'; // 默认折叠

        const header = document.createElement('div');
        header.style.display = 'inline-block';

        if (!isEmpty) {
            const toggle = document.createElement('span');
            toggle.className = 'jv-toggle';
            toggle.textContent = '▼';
            const toggleAction = (e) => {
                e.stopPropagation();
                const isCollapsed = container.classList.contains('collapsed');
                if (isCollapsed) {
                    container.classList.remove('collapsed');
                    container.classList.add('expanded');
                } else {
                    container.classList.remove('expanded');
                    container.classList.add('collapsed');
                }
            };
            toggle.onclick = toggleAction;
            header.style.cursor = 'pointer';
            header.onclick = toggleAction;
            header.appendChild(toggle);
        } else {
            const spacer = document.createElement('span');
            spacer.style.width = '14px';
            spacer.style.display = 'inline-block';
            header.appendChild(spacer);
        }

        if (key !== null) {
            header.appendChild(createSpan(`"${key}"`, 'jv-key'));
            header.appendChild(createSpan(': ', 'jv-punct'));
        }

        header.appendChild(createSpan(openChar, 'jv-punct'));

        if (!isEmpty) {
            const count = isArray ? data.length : Object.keys(data).length;
            const info = isArray ? `Array(${count})` : `...`;
            const ellipsis = createSpan(info, 'jv-ellipsis');
            header.appendChild(ellipsis);
        }

        container.appendChild(header);

        if (!isEmpty) {
            const childrenContainer = document.createElement('div');
            childrenContainer.className = 'jv-children';
            for (let k in data) {
                if (Object.prototype.hasOwnProperty.call(data, k)) {
                    const itemRow = document.createElement('div');
                    itemRow.className = 'jv-item';
                    const childNode = createJsonTree(data[k], isArray ? null : k);
                    itemRow.appendChild(childNode);
                    childrenContainer.appendChild(itemRow);
                }
            }
            container.appendChild(childrenContainer);
        }

        const footer = document.createElement('div');
        footer.className = 'jv-footer';
        footer.appendChild(createSpan(closeChar, 'jv-punct'));
        container.appendChild(footer);

        return container;
    }

    function renderPrimitive(text, className, key) {
        const wrapper = document.createElement('div');
        wrapper.className = 'json-tree';
        const spacer = document.createElement('span');
        spacer.style.width = '14px';
        spacer.style.display = 'inline-block';
        wrapper.appendChild(spacer);
        if (key !== null) {
            wrapper.appendChild(createSpan(`"${key}"`, 'jv-key'));
            wrapper.appendChild(createSpan(': ', 'jv-punct'));
        }
        wrapper.appendChild(createSpan(text, className));
        return wrapper;
    }

    // --- 日志系统 ---
    function getTimeString() {
        const now = new Date();
        return now.toLocaleTimeString('en-GB') + '.' + now.getMilliseconds().toString().padStart(3, '0');
    }

    function addLogToUI(tag, args, level = "info") {
        const div = document.createElement('div');
        div.className = 'log-row';
        if (level === "error") {
            div.classList.add('log-row-error');
        }

        let tagClass = "tag-info";
        if (level === "error") {
            tagClass = "tag-error";
        } else if (level === "warn") {
            tagClass = "tag-warn";
        } else if (level === "success") {
            tagClass = "tag-success";
        } else if (tag === "SYS") {
            tagClass = "tag-sys";
        }

        const metaDiv = document.createElement('div');
        metaDiv.className = 'log-meta';
        metaDiv.innerHTML = `<span class="log-time">${getTimeString()}</span><span class="log-tag ${tagClass}">[${tag}]</span>`;
        div.appendChild(metaDiv);

        const contentDiv = document.createElement('div');
        contentDiv.className = 'log-content';

        const argList = Array.isArray(args) ? args : [args];
        argList.forEach((arg, index) => {
            if (index > 0) {
                contentDiv.appendChild(createSpan(' ', ''));
            }
            if (typeof arg === 'object' && arg !== null) {
                contentDiv.appendChild(createJsonTree(arg));
            } else {
                const span = document.createElement('span');
                span.style.verticalAlign = 'top';
                span.textContent = String(arg);
                contentDiv.appendChild(span);
            }
        });

        div.appendChild(contentDiv);
        output.appendChild(div);
        if (isAutoScroll) {
            output.scrollTop = output.scrollHeight;
        }
    }

    function clearLog() {
        output.innerHTML = '';
        addLogToUI("SYS", "已清空", "info");
    }

    function toggleAutoScroll() {
        isAutoScroll = !isAutoScroll;
        const btn = document.getElementById('btnAutoScroll');
        btn.innerText = isAutoScroll ? "自动滚动: ON" : "自动滚动: OFF";
        btn.style.color = isAutoScroll ? "#FFF" : "#777";
    }

    // --- 劫持 ---
    const originalConsole = {log: console.log, warn: console.warn, error: console.error, info: console.info};

    function enableConsoleCapture() {
        console.log = (...args) => {
            addLogToUI("LOG", args, "info");
            originalConsole.log.apply(console, args);
        };
        console.warn = (...args) => {
            addLogToUI("WARN", args, "warn");
            originalConsole.warn.apply(console, args);
        };
        console.error = (...args) => {
            addLogToUI("ERR", args, "error");
            originalConsole.error.apply(console, args);
        };
        console.info = (...args) => {
            addLogToUI("INFO", args, "success");
            originalConsole.info.apply(console, args);
        };
    }

    function disableConsoleCapture() {
        console.log = originalConsole.log;
        console.warn = originalConsole.warn;
        console.error = originalConsole.error;
        console.info = originalConsole.info;
    }

    // --- 核心：连接状态检查 ---
    // 检查核心是否真正加载，并相应地更新 UI
    function updateEngineStatus() {
        let isConnected = false;
        try {
            if (iframe.contentWindow && iframe.contentWindow.MathPlus) {
                isConnected = true;
            }
        } catch (e) {
        }

        // 获取所有测试按钮 (除了清空日志)
        const buttons = document.querySelectorAll('button#testBtn, button.test-case-btn');

        if (isConnected) {
            statusDot.className = "status-dot active";
            statusText.innerText = "就绪 - 已连接";
            buttons.forEach(b => b.disabled = false);
        } else {
            statusDot.className = "status-dot error";
            statusText.innerText = "连接失败 (Core Missing)";
            buttons.forEach(b => b.disabled = true);
        }
        return isConnected;
    }

    // --- 运行器 ---
    async function uiRunTest(mode) {
        // 运行时禁用按钮
        document.querySelectorAll('button:not(.console-header button)').forEach(b => b.disabled = true);
        const mapTitle = {0: "全部测试集", 1: "性能测试", 2: "幂函数", 3: "统计", 4: "根式", 5: "值列表", 6: "表达式"};

        statusDot.className = "status-dot loading";
        statusText.innerText = `Running...`;

        const hr = document.createElement('div');
        hr.style.borderTop = '1px dashed #333';
        hr.style.margin = '10px 0';
        output.appendChild(hr);

        addLogToUI("SYS", `>>> 开始: ${mapTitle[mode] || mode}`, "sys");
        enableConsoleCapture();

        try {
            await new Promise(r => setTimeout(r, 50));

            // 检查连接，防止中途断开
            if (!updateEngineStatus()) {
                throw new Error("引擎连接断开");
            }

            const result = await test(mode);

            const msg = mode === 0 ? "全部测试集" : "当前测试集";
            if (result) {
                addLogToUI("SYS", `<<< ${msg}通过`, "success");
            } else {
                addLogToUI("SYS", `<<< ${msg}未通过 (存在错误)`, "error");
            }

        } catch (e) {
            addLogToUI("FATAL", e.message, "error");
            originalConsole.error(e);
        } finally {
            disableConsoleCapture();
            document.getElementById('clearBtn').disabled = false;
            // 重新检查连接状态，而不是盲目设置为 Ready
            updateEngineStatus();
        }
    }

    // Iframe 加载事件
    iframe.onload = () => {
        const connected = updateEngineStatus();
        if (connected) {
            addLogToUI("SYS", "核心组件 MathPlus 已加载。", "success");
        } else {
            addLogToUI("ERR", "Iframe 已加载，但未找到 MathPlus 对象 (可能由于路径错误)。", "error");
        }
    };

    // 初始检查 (防止缓存导致 onload 不触发)
    if (iframe.contentWindow && iframe.contentWindow.document.readyState === 'complete') {
        updateEngineStatus();
    }

</script>

<script type="text/javascript" id="testLogic">
    "use strict";

    function measureTime(func) {
        const s = Date.now();
        func();
        return Date.now() - s;
    }

    function deepEqual(obj1, obj2) {
        if (obj1 === obj2) {
            return true;
        }
        if (typeof obj1 === 'number' && typeof obj2 === 'number' && isNaN(obj1) && isNaN(obj2)) {
            return true;
        }
        if (obj1 === null || typeof obj1 !== 'object' || obj2 === null || typeof obj2 !== 'object') {
            return false;
        }
        if (obj1 instanceof Date && obj2 instanceof Date) {
            return obj1.getTime() === obj2.getTime();
        }
        const k1 = Object.keys(obj1), k2 = Object.keys(obj2);
        if (k1.length !== k2.length) {
            return false;
        }
        for (let k of k1) {
            if (!k2.includes(k) || !deepEqual(obj1[k], obj2[k])) {
                return false;
            }
        }
        return true;
    }

    async function fetchJson(url) {
        try {
            return await (await fetch(url + '?t=' + Date.now())).json();
        } catch (e) {
            console.error("Fetch error:", e);
            return [];
        }
    }

    async function test(mode = 0) {
        const win = iframe.contentWindow;
        if (!win || !win.MathPlus) {
            throw new Error("Core not loaded");
        }

        const a = win.CalcConfig.globalCalcAccuracy, b = win.CalcConfig.outputAccuracy;
        win.CalcConfig.globalCalcAccuracy = 220;
        win.CalcConfig.outputAccuracy = 0.9;

        let result = true;

        const logResult = (title, pass, input, expected, actual, extra = {}) => {
            const logData = {Input: input, Expected: expected, Actual: actual, ...extra};
            if (pass) {
                console.log(`✅ ${title}`, logData);
            } else {
                console.error(`❌ ${title}`, logData);
            }
        };

        switch (mode) {
            case 1: {
                console.info("--- 性能基准测试 (Batch) ---");

                // 1. 定义测试配置
                const count = 111; // 循环次数
                const num1 = new win.ComplexNumber('23.4-42.8[i]');
                const num2 = new win.ComplexNumber('-12.43+3.21[i]');

                // 2. 定义要测试的函数集
                // name: 显示名称
                // run:  实际执行的包装函数
                // args: 用于在日志中显示的输入参数列表 (仅作展示用)
                const testSet = [
                    {
                        name: "Pow",
                        run: () => win.MathPlus.pow(num1, num2),
                        args: [num1, num2]
                    },
                    {
                        name: "Fact",
                        run: () => win.MathPlus.fact(num2),
                        args: [num2]
                    }
                    // 你可以在这里继续添加其他函数...
                    // { name: "Exp", run: () => win.MathPlus.exp(num1), args: [num1] },
                ];

                // 3. 批量循环测试
                for (const item of testSet) {
                    let totalTime = 0;

                    // 执行性能测试循环
                    for (let i = 0; i < count; i++) {
                        totalTime += measureTime(item.run);
                    }

                    // 4. 按照你的格式输出日志
                    console.log(`${item.name}:`, {
                        LoopCount: count,
                        Input: item.args.map(arg => arg.toString()), // 转换参数为字符串以便阅读
                        Actual: item.run().toString(),               // 获取实际计算结果
                        Time: '平均一次计算耗时：' + (totalTime / count).toFixed(3) + 'ms' // 平均耗时
                    });
                }
                break;
            }
            case 2: { // Power
                let allPass = true;
                const cases = await fetchJson('test_cases/test_power_function.json');
                for (let i = 0; i < cases.length; i++) {
                    const c = cases[i];
                    const res = await win.WorkerTools.powerFunctionAnalysis(c.coeffs);
                    const pass = deepEqual(c.expected, res);
                    allPass = allPass && pass;
                    logResult(`Case ${i + 1}: ${c.description[0]}`, pass, c.coeffs, c.expected, res);
                }
                result = allPass;
                break;
            }
            case 3: { // Stats
                let allPass = true;
                const cases = await fetchJson('test_cases/test_statistics.json');
                for (let i = 0; i < cases.length; i++) {
                    const c = cases[i];
                    const res = await win.WorkerTools.statisticsCalc(c.coeffs[0], c.coeffs[1]);
                    const pass = deepEqual(c.expected, res);
                    allPass = allPass && pass;
                    logResult(`Case ${i + 1}`, pass, c.coeffs, c.expected, res);
                }
                result = allPass;
                break;
            }
            case 4: { // Radical
                let allPass = true;
                const cases = await fetchJson('test_cases/test_radical_function.json');
                for (let i = 0; i < cases.length; i++) {
                    const c = cases[i];
                    const res = await win.WorkerTools.radicalFunctionAnalysis(c.coeffs[0], c.coeffs[1]);
                    const pass = deepEqual(c.expected, res);
                    allPass = allPass && pass;
                    logResult(`Case ${i + 1}`, pass, {z: c.coeffs[0], n: c.coeffs[1]}, c.expected, res);
                }
                result = allPass;
                break;
            }
            case 5: { // ValueList
                let allPass = true;
                const cases = await fetchJson('test_cases/test_func_value_list.json');
                for (let i = 0; i < cases.length; i++) {
                    const c = cases[i];
                    const res = await win.WorkerTools.valueList(...c.coeffs);
                    const pass = deepEqual(c.expected, res);
                    allPass = allPass && pass;
                    logResult(`Case ${i + 1}`, pass, c.coeffs, c.expected, res);
                }
                result = allPass;
                break;
            }
            case 6: { // Expr
                let allPass = true;
                const cases = await fetchJson('test_cases/test_calc_expr.json');
                for (let i = 0; i < cases.length; i++) {
                    const c = cases[i];
                    const opts = {
                        calcAcc: c.coeffs[1],
                        outputAcc: c.coeffs[2],
                        calcMode: c.coeffs[3],
                        outputMode: c.coeffs[4],
                        f: c.coeffs[5],
                        g: c.coeffs[6]
                    };
                    const res = await win.WorkerTools.exec(c.coeffs[0], opts);
                    let pass = deepEqual(c.expected, res);

                    let idealPass = true;
                    if (win.Public) {
                        const midRes = await win.WorkerTools.exec(c.coeffs[0], {...opts, outputMode: 'mid'});
                        const idealized = win.Public.idealizationToString(new win.ComplexNumber(midRes.result), {acc: c.coeffs[2]});
                        idealPass = (idealized === res.result);
                    }
                    pass = pass && idealPass;

                    logResult(
                        `Case ${i + 1}: ${c.coeffs[0]}`,
                        pass,
                        c.coeffs,
                        c.expected,
                        res,
                        {SyntaxCheck: idealPass}
                    );
                    allPass = allPass && pass;
                }
                result = allPass;
                break;
            }
            default: {
                const sections = {
                    2: "幂函数分析",
                    3: "统计计算",
                    4: "根式函数",
                    5: "函数值列表",
                    6: "表达式解析"
                };
                for (let i = 2; i <= 6; i++) {
                    console.info(`\n============== [${i}] ${sections[i]} ==============`);
                    const subResult = await test(i);
                    result = subResult && result;
                }
                break;
            }
        }
        win.CalcConfig.globalCalcAccuracy = a;
        win.CalcConfig.outputAccuracy = b;
        return result;
    }
</script>
</body>
</html>